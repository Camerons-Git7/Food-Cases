name: Build iOS App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install Capacitor
      run: |
        npm install -g @capacitor/cli @capacitor/core @capacitor/ios
    
    - name: Create build directory and copy files
      run: |
        mkdir -p www
        cp *.html www/ 2>/dev/null || true
        cp -r assets www/ 2>/dev/null || true
    
    - name: Create Capacitor Config
      run: |
        rm -f capacitor.config.json
        cat > capacitor.config.json << 'EOF'
        {
          "appId": "com.cameronsgit7.foodcases",
          "appName": "FoodCases",
          "webDir": "www",
          "ios": {
            "minVersion": "14.0"
          }
        }
        EOF
    
    - name: Install iOS Platform Package
      run: |
        npm install @capacitor/ios --save
    
    - name: Manually Create iOS Project
      run: |
        mkdir -p ios/App
        cd ios/App
        
        # Create Podfile with correct deployment target
        cat > Podfile << 'EOF'
        platform :ios, '14.0'
        use_frameworks!
        
        # workaround to avoid Xcode caching of Pods that requires
        # Product -> Clean Build Folder after new Cordova plugins installed
        # Requires CocoaPods 1.6 or newer
        install! 'cocoapods', :disable_input_output_paths => true
        
        def capacitor_pods
          # Automatic Capacitor Pod dependencies, do not delete
          pod 'Capacitor', :path => '../../node_modules/@capacitor/ios'
          pod 'CapacitorCordova', :path => '../../node_modules/@capacitor/ios'
          # Do not delete
        end
        
        target 'App' do
          capacitor_pods
          # Add your Pods here
        end
        
        post_install do |installer|
          assertDeploymentTarget(installer)
        end
        EOF
        
        # Create basic Xcode project structure
        mkdir -p App
        cat > App/Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleDevelopmentRegion</key>
            <string>en</string>
            <key>CFBundleDisplayName</key>
            <string>FoodCases</string>
            <key>CFBundleExecutable</key>
            <string>App</string>
            <key>CFBundleIdentifier</key>
            <string>com.cameronsgit7.foodcases</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>CFBundleName</key>
            <string>$(PRODUCT_NAME)</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0</string>
            <key>CFBundleVersion</key>
            <string>1</string>
            <key>LSRequiresIPhoneOS</key>
            <true/>
            <key>UILaunchStoryboardName</key>
            <string>LaunchScreen</string>
            <key>UIMainStoryboardFile</key>
            <string>Main</string>
            <key>UIRequiredDeviceCapabilities</key>
            <array>
                <string>armv7</string>
            </array>
            <key>UISupportedInterfaceOrientations</key>
            <array>
                <string>UIInterfaceOrientationPortrait</string>
                <string>UIInterfaceOrientationLandscapeLeft</string>
                <string>UIInterfaceOrientationLandscapeRight</string>
            </array>
        </dict>
        </plist>
        EOF
    
    - name: Install Pods
      run: |
        cd ios/App
        pod install --repo-update
    
    - name: Sync Web Assets
      run: |
        npx cap copy ios
    
    - name: Upload iOS Project
      uses: actions/upload-artifact@v4
      with:
        name: ios-project
        path: ios/
